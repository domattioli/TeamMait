"""
Embedded Timer Component for Streamlit Cloud
This version doesn't require a separate HTTP server.
Works on Streamlit Cloud, local dev, and anywhere else.
"""

import streamlit as st
import streamlit.components.v1 as components
from pathlib import Path


def countdown_timer(key=None):
    """
    Render an embedded countdown timer that doesn't require a separate server.
    
    The timer:
    - Counts down from 20 minutes
    - Updates in real-time in the browser (no Streamlit reruns)
    - Displays at fixed position (top-left)
    - Changes color: green → amber (at 2 min) → red (at 0)
    
    Args:
        key: Streamlit component key
        
    Returns:
        Dictionary with timer state
    """
    
    # HTML/CSS/JavaScript for the timer
    timer_html = """
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Courier New', monospace;
                background: transparent;
            }

            .timer-container {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 9999;
                background: rgba(15, 23, 42, 0.95);
                border: 1px solid rgba(100, 116, 139, 0.5);
                border-radius: 8px;
                padding: 12px 16px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(8px);
                font-family: 'Courier New', monospace;
            }

            .timer-label {
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 1px;
                color: rgba(148, 163, 184, 0.8);
                margin-bottom: 4px;
                font-weight: 600;
            }

            .timer-display {
                font-size: 24px;
                font-weight: 700;
                letter-spacing: 2px;
                font-variant-numeric: tabular-nums;
                color: #10b981;
                transition: color 0.2s ease;
            }

            .timer-display.warning {
                color: #f59e0b;
                animation: pulse-warning 1s ease-in-out infinite;
            }

            .timer-display.expired {
                color: #ef4444;
                animation: pulse-expired 0.6s ease-in-out infinite;
            }

            @keyframes pulse-warning {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.7;
                }
            }

            @keyframes pulse-expired {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .timer-status {
                font-size: 9px;
                color: rgba(148, 163, 184, 0.6);
                margin-top: 2px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            @media (max-width: 600px) {
                .timer-container {
                    padding: 10px 12px;
                    top: 10px;
                    left: 10px;
                }

                .timer-display {
                    font-size: 18px;
                }

                .timer-label {
                    font-size: 10px;
                }
            }
        </style>
    </head>
    <body>
        <div class="timer-container" id="timer">
            <div class="timer-label">Session Time</div>
            <div class="timer-display" id="display">--:--</div>
            <div class="timer-status" id="status">Waiting</div>
        </div>

        <script>
            const TOTAL_TIME_MS = 20 * 60 * 1000; // 20 minutes
            const WARNING_TIME_MS = 2 * 60 * 1000; // 2 minutes warning

            let startTime = null;
            let isRunning = false;
            let animationId = null;

            const display = document.getElementById('display');
            const status = document.getElementById('status');

            function formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            function updateDisplay() {
                if (!isRunning || startTime === null) return;

                const elapsed = Date.now() - startTime;
                const remaining = TOTAL_TIME_MS - elapsed;

                if (remaining <= 0) {
                    // Time expired
                    display.textContent = '00:00';
                    status.textContent = 'EXPIRED';
                    display.classList.remove('warning');
                    display.classList.add('expired');
                    isRunning = false;
                    cancelAnimationFrame(animationId);
                    return;
                }

                display.textContent = formatTime(remaining);

                // Update color based on remaining time
                if (remaining <= WARNING_TIME_MS) {
                    display.classList.add('warning');
                    display.classList.remove('expired');
                    status.textContent = '2 MIN LEFT';
                } else {
                    display.classList.remove('warning', 'expired');
                    status.textContent = 'RUNNING';
                }

                animationId = requestAnimationFrame(updateDisplay);
            }

            // Expose functions for Streamlit to call
            window.startCountdownTimer = function() {
                startTime = Date.now();
                isRunning = true;
                status.textContent = 'RUNNING';
                display.classList.remove('expired');
                updateDisplay();
            };

            window.stopCountdownTimer = function() {
                isRunning = false;
                if (animationId) cancelAnimationFrame(animationId);
                status.textContent = 'PAUSED';
            };

            window.resetCountdownTimer = function() {
                startTime = null;
                isRunning = false;
                if (animationId) cancelAnimationFrame(animationId);
                display.textContent = '--:--';
                status.textContent = 'WAITING';
                display.classList.remove('warning', 'expired');
            };

            window.isTimerRunning = function() {
                return isRunning;
            };

            window.getElapsedTime = function() {
                if (!startTime) return 0;
                return Date.now() - startTime;
            };

            window.getRemainingTime = function() {
                if (!startTime) return TOTAL_TIME_MS;
                const elapsed = Date.now() - startTime;
                const remaining = TOTAL_TIME_MS - elapsed;
                return Math.max(0, remaining);
            };
        </script>
    </body>
    </html>
    """
    
    # Render the HTML
    components.html(timer_html, height=80)


def start_timer():
    """Start the timer via JavaScript injection."""
    components.html(
        """
        <script>
        if (window.startCountdownTimer) {
            window.startCountdownTimer();
        }
        </script>
        """,
        height=0,
    )


def stop_timer():
    """Stop the timer via JavaScript injection."""
    components.html(
        """
        <script>
        if (window.stopCountdownTimer) {
            window.stopCountdownTimer();
        }
        </script>
        """,
        height=0,
    )


def reset_timer():
    """Reset the timer via JavaScript injection."""
    components.html(
        """
        <script>
        if (window.resetCountdownTimer) {
            window.resetCountdownTimer();
        }
        </script>
        """,
        height=0,
    )


def is_timer_running():
    """Check if timer is running (requires additional session state tracking)."""
    if "timer_running" not in st.session_state:
        st.session_state.timer_running = False
    return st.session_state.timer_running


def get_timer_status():
    """Get current timer status from session state."""
    if "timer_start" not in st.session_state:
        st.session_state.timer_start = None
    
    if st.session_state.timer_start is None:
        return {
            "running": False,
            "elapsed_ms": 0,
            "remaining_ms": 20 * 60 * 1000,
            "expired": False,
        }
    
    from datetime import datetime
    elapsed = (datetime.now() - st.session_state.timer_start).total_seconds() * 1000
    remaining = (20 * 60 * 1000) - elapsed
    
    return {
        "running": True,
        "elapsed_ms": int(elapsed),
        "remaining_ms": int(max(0, remaining)),
        "expired": remaining <= 0,
    }